<div class="pb-10">

    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-semibold text-fg-default">Nueva Receta</h2>
            <p class="text-sm text-fg-muted">Añade un nuevo plato a tu colección.</p>
        </div>

        <div class="flex gap-3">
            <a routerLink="/dishes"
                class="px-4 py-2 border border-border-default rounded-md overflow-hidden text-sm font-medium text-fg-default hover:bg-canvas-subtle transition-colors no-underline flex items-center">
                Cancelar
            </a>
            <button (click)="save()" [disabled]="form.invalid || saving()"
                class="bg-primary-default hover:bg-primary-hover text-white px-4 py-2 rounded-md text-sm font-medium shadow-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                <span *ngIf="saving()"
                    class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full block"></span>
                {{ saving() ? 'Guardando...' : 'Guardar Receta' }}
            </button>
        </div>
    </div>

    <form [formGroup]="form" class="space-y-6">

        <div class="border border-border-default rounded-md overflow-hidden bg-white shadow-sm overflow-hidden">
            <div class="p-4 border-b border-border-default bg-canvas-subtle">
                <h3 class="text-sm font-semibold text-fg-default m-0">Información General</h3>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2">
                    <label class="block text-xs font-semibold text-fg-default mb-1.5">Nombre del Plato</label>
                    <mat-form-field appearance="outline" class="w-full compact-form-field">
                        <input matInput formControlName="name" placeholder="Ej: Lentejas con chorizo">
                    </mat-form-field>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-fg-default mb-1.5">Porciones</label>
                    <mat-form-field appearance="outline" class="w-full compact-form-field">
                        <input matInput type="number" formControlName="servings">
                        <span matSuffix class="text-xs text-fg-muted pr-2">personas</span>
                    </mat-form-field>
                </div>
            </div>
        </div>

        <div class="border border-border-default rounded-md overflow-hidden bg-white shadow-sm overflow-hidden">
            <div class="p-4 border-b border-border-default bg-canvas-subtle flex justify-between items-center">
                <h3 class="text-sm font-semibold text-fg-default m-0">Ingredientes</h3>
                <button type="button" (click)="addIngredient()"
                    class="text-accent-default hover:underline text-xs font-semibold flex items-center gap-1">
                    <mat-icon class="icon-xs">add</mat-icon> Añadir fila
                </button>
            </div>

            <div class="p-0" formArrayName="ingredients">
                <div
                    class="grid grid-cols-12 gap-4 px-6 py-2 bg-canvas-inset border-b border-border-muted text-xs font-semibold text-fg-muted uppercase tracking-wider">
                    <div class="col-span-6 md:col-span-7">Nombre</div>
                    <div class="col-span-3 md:col-span-2">Cantidad</div>
                    <div class="col-span-3 md:col-span-2">Unidad</div>
                </div>

                <div *ngFor="let ing of ingredients.controls; index as i" [formGroupName]="i"
                    class="grid grid-cols-12 gap-4 px-6 py-3 border-b border-border-muted last:border-b-0 items-start group">

                    <div class="col-span-6 md:col-span-7">
                        <mat-form-field appearance="outline" class="w-full compact-form-field no-subscript">
                            <input matInput formControlName="name" placeholder="Ej: Cebolla">
                        </mat-form-field>
                    </div>

                    <div class="col-span-3 md:col-span-2">
                        <mat-form-field appearance="outline" class="w-full compact-form-field no-subscript">
                            <input matInput type="number" formControlName="amount">
                        </mat-form-field>
                    </div>

                    <div class="col-span-3 md:col-span-2 relative">
                        <mat-form-field appearance="outline" class="w-full compact-form-field no-subscript">
                            <input matInput formControlName="unit" placeholder="unid">
                        </mat-form-field>

                        <button type="button" (click)="removeIngredient(i)"
                            class="absolute -right-8 top-2 text-fg-muted hover:text-danger-default opacity-0 group-hover:opacity-100 transition-opacity"
                            title="Borrar ingrediente">
                            <mat-icon class="icon-sm">close</mat-icon>
                        </button>
                    </div>
                </div>

                <div *ngIf="ingredients.length === 0" class="p-6 text-center text-fg-muted text-sm">
                    No hay ingredientes. Añade uno para empezar.
                </div>
            </div>
        </div>

        <div class="border border-border-default rounded-md overflow-hidden bg-white shadow-sm overflow-hidden">
            <div class="p-4 border-b border-border-default bg-canvas-subtle flex justify-between items-center">
                <h3 class="text-sm font-semibold text-fg-default m-0">Instrucciones de Preparación</h3>
                <button type="button" (click)="addStep()"
                    class="text-accent-default hover:underline text-xs font-semibold flex items-center gap-1">
                    <mat-icon class="icon-xs">add</mat-icon> Añadir paso
                </button>
            </div>

            <div class="p-6 space-y-4" formArrayName="steps">
                <div *ngFor="let s of steps.controls; index as i" class="flex gap-3 group">
                    <div class="pt-2">
                        <span
                            class="flex items-center justify-center w-6 h-6 rounded-full bg-canvas-subtle border border-border-default text-xs font-bold text-fg-muted">
                            {{ i + 1 }}
                        </span>
                    </div>
                    <div class="flex-grow">
                        <mat-form-field appearance="outline" class="w-full compact-form-field">
                            <textarea matInput [formControlName]="i" rows="2"
                                placeholder="Describe el paso..."></textarea>
                        </mat-form-field>
                    </div>
                    <div class="pt-2">
                        <button type="button" (click)="removeStep(i)"
                            class="text-fg-muted hover:text-danger-default opacity-0 group-hover:opacity-100 transition-opacity">
                            <mat-icon class="icon-sm">delete</mat-icon>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </form>
</div>