<div class="container mx-auto p-6 max-w-[1200px] print:p-0 print:max-w-none">

    <div class="flex flex-col md:flex-row justify-between items-end mb-6 print:hidden">
        <div class="mb-4 md:mb-0">
            <h2 class="text-2xl font-semibold text-fg-default mb-1">Planificador</h2>
            <p class="text-sm text-fg-muted">Organiza tus comidas para la semana.</p>
        </div>

        <div class="flex gap-2">
            <button mat-stroked-button (click)="share()">
                <mat-icon>share</mat-icon> Compartir
            </button>
            <button mat-stroked-button (click)="print()">
                <mat-icon>print</mat-icon> Imprimir
            </button>
            <button mat-stroked-button color="warn" (click)="deletePlan()">
                <mat-icon>delete</mat-icon> Borrar
            </button>
        </div>
    </div>

    <div *ngIf="loading()" class="flex justify-center py-12 print:hidden">
        <span class="text-fg-muted animate-pulse">Cargando calendario...</span>
    </div>

    <ng-container *ngIf="viewData() as data">

        <div *ngFor="let month of data.months" class="mb-8 break-inside-avoid">

            <h3 class="text-lg font-bold text-fg-default !mb-3 capitalize border-b border-border-default pb-2">
                Mes: {{ month.title }}
            </h3>

            <div class="bg-canvas-default border border-border-default rounded-md shadow-sm overflow-hidden">

                <div class="grid grid-cols-7 border-b border-border-default bg-canvas-subtle">
                    <div *ngFor="let dayName of ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom']"
                        class="py-2 text-center text-xs font-semibold text-fg-muted uppercase tracking-wider border-r border-border-default last:border-r-0">
                        {{ dayName }}
                    </div>
                </div>

                <div class="grid grid-cols-7 auto-rows-fr">

                    <div *ngFor="let date of month.dates; let i = index"
                        class="relative min-h-[140px] p-3 border-b border-r border-border-default transition-colors group"
                        [class.border-r-0]="(i + 1) % 7 === 0" [class.border-b-0]="i >= month.dates.length - 7"
                        [ngClass]="{
                            'bg-gray-100 cursor-not-allowed opacity-60': isPast(date) && date, 
                            'bg-white hover:bg-canvas-inset cursor-pointer': isInPlan(date, data.planStartStr, data.planEndStr) && !isPast(date),
                            'bg-canvas-subtle cursor-pointer hover:bg-blue-50': !isInPlan(date, data.planStartStr, data.planEndStr) && date && !isPast(date)
                         }" (click)="date ? openDay(date, data) : null">

                        <ng-container *ngIf="date">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-sm font-medium"
                                    [class.text-fg-muted]="!isInPlan(date, data.planStartStr, data.planEndStr) || isPast(date)"
                                    [class.text-fg-default]="isInPlan(date, data.planStartStr, data.planEndStr) && !isPast(date)">
                                    {{ date | date:'d' }}
                                </span>

                                <span *ngIf="isPast(date)"
                                    class="text-[10px] uppercase font-bold text-fg-muted bg-gray-200 px-1 rounded">
                                    Pasado
                                </span>
                            </div>

                            <div class="flex flex-col h-full">

                                <ng-container *ngIf="isInPlan(date, data.planStartStr, data.planEndStr)">
                                    <ng-container *ngIf="getDishName(date, data.plan, data.dishesMap) as dishName">
                                        <div *ngIf="dishName !== '—'" class="mt-1">
                                            <div class="bg-white border border-border-muted rounded px-2 py-1.5 text-sm text-fg-default shadow-sm break-words"
                                                [class.opacity-70]="isPast(date)"> {{ dishName }}
                                            </div>
                                        </div>
                                        <div *ngIf="dishName === '—' && !isPast(date)"
                                            class="flex-grow flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                            <div
                                                class="w-8 h-8 rounded-full bg-canvas-default border border-border-default flex items-center justify-center text-fg-muted shadow-sm">
                                                <mat-icon class="text-sm !w-4 !h-4 !leading-4">add</mat-icon>
                                            </div>
                                        </div>
                                    </ng-container>
                                </ng-container>

                                <div *ngIf="!isInPlan(date, data.planStartStr, data.planEndStr) && !isPast(date)"
                                    class="flex-grow flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button
                                        class="flex items-center gap-1 text-xs font-semibold text-primary-DEFAULT bg-primary-bg px-2 py-1 rounded hover:bg-primary-hover hover:text-white transition-colors">
                                        <mat-icon class="icon-xs">add</mat-icon> Añadir día
                                    </button>
                                </div>

                            </div>
                        </ng-container>

                        <ng-container *ngIf="!date">
                            <div class="h-full bg-canvas-subtle border-b border-r border-transparent"></div>
                        </ng-container>

                    </div>
                </div>
            </div>
        </div>

        <!--  -->

        <div class="mt-8 text-center pb-10" *ngIf="viewData() as data">
    
            <p class="text-fg-muted text-sm mb-4">
                Planificado hasta el <strong>{{ data.planEndStr | date:'longDate' }}</strong>
            </p>
            
            <div class="flex justify-center gap-4">
                
                <button *ngIf="data.canLoadNextMonth" 
                        mat-stroked-button 
                        (click)="loadNextMonth()">
                    <mat-icon>calendar_view_month</mat-icon> Ver siguiente mes
                </button>

                <button *ngIf="isPlanFinished(data.planEndStr)" 
                        mat-flat-button color="primary" 
                        routerLink="/planner/settings">
                    <mat-icon>restart_alt</mat-icon> Nueva Planificación
                </button>
            </div>

        </div>

        <!-- <div class="mt-8 text-center pb-10">
            <p class="text-fg-muted text-sm mb-3">Has planificado hasta el {{ data.planEndStr | date:'longDate' }}</p>

            <button mat-stroked-button color="primary" routerLink="/planner/settings">
                <mat-icon>calendar_today</mat-icon> Comenzar nueva planificación desde cero
            </button>
        </div> -->

    </ng-container>
</div>